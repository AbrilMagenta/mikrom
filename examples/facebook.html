<!doctype html>
<html>
  <head>
    <title>Basic Mikrom Templates test</title>
    
    <style>
      .app {
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="app" app-if="!appState.loading">
      <div app-if="appState.facebookReady">
        <div app-if="appState.loggedIn">
          <p>Welcome <span app-bind="user.name"></span>.</p>
          
        </div>
        
        <div app-if="!appState.loggedIn">
          <a app-click="facebookLogin()">Log in with Facebook</a>
        </div>      
      </div>
      
      <div app-if="!appState.facebookReady">
        Loading Facebook...
      </div>
    </div>
    
    <script>
      window.fbAsyncInit = function() {
        FB.init({
          appId      : '195160424148717',
          xfbml      : true,
          version    : 'v2.5'
        });
        
        appState.facebookReady = true;
        appState.refresh();
      };

      (function(d, s, id){
         var js, fjs = d.getElementsByTagName(s)[0];
         if (d.getElementById(id)) {return;}
         js = d.createElement(s); js.id = id;
         js.src = "https://connect.facebook.net/en_US/sdk.js";
         fjs.parentNode.insertBefore(js, fjs);
       }(document, 'script', 'facebook-jssdk'));
    </script>
    
    <script src="../dist/mikrom.js"></script>
    <script src="../dist/mikrom.templates.min.js"></script>
    <script>
      var appState = {
        __vars: {},
        
        refresh: function() {
          var e = document.createEvent("Event");
          e.initEvent("state.change");
          window.dispatchEvent(e);
        }
      }
      
      function facebookLogin() {
        FB.login(function(response) {
          if (response.status == "connected") {
            FB.api("/me", function(response2) {
              appState.user = response2;
              
              FB.api("/me/photos", function(response3) {
                appState.user.photos = response3;
                appState.loggedIn = true;
                appState.refresh();
              })
            })
          }else{
            alert("You have to log in :(!")
          }
        }, {scope: "user_photos"})
      }
      
      mikrom.component("[app-click]", function(el, attr) {
        this.addEventListener("click", function() {
          eval(attr.appClick);
          appState.refresh();
        })
      });
      
      mikrom.component("[app-if]", function(el, attr) {
        var el = this;
        
        window.addEventListener("state.change", function() {
          if (eval(attr.appIf)) {
            el.style.display = "block";
          }else{
            el.style.display = "none";
          }
        })
      })
      
      mikrom.component("[app-bind]", function(el,attr) {
        if (el.nodeName == "INPUT") {
          el.addEventListener("input", function() {
            appState.vars[attr.appBind] = el.value;
            appState.refresh();
          })
        }else{
          window.addEventListener("state.change", function() {
            el.innerHTML = eval("appState." + attr.appBind);
          });
        }
      });
      
      // Initialize components
      mikrom.init();
      appState.user = {};
      appState.loading = false;
      appState.facebookReady = false;
    </script>
  </body>
</html>